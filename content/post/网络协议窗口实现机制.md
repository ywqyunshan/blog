---
layout:     post

title:      "网络协议窗口实现机制"
subtitle:   ""
excerpt: ""
author:     "iigeoywq button"
date:       2025-12-05
published: true 
tags:
    - 系统理论 

categories: [ Tech ]
URL: "/2025/12/05/"
---
> 车载网络协议主要解决实时性和可靠性，本文主要说说TCP/RTPS协议如何解决可靠性，如何实现重传，时序等问题。

## 1 TCP/RTPS网络协议
![网络协议层级图](/img/网络协议层级.png)

下面说几个概念：
* ACK(Acknowledgment) 确认收到；
* SACK(Selective Acknowledgment) 选择性确认；
* ACK-NACK 确认收到，确认没有收到；
* Delayed ACK 延迟确认收到；，为了减少恢复的ACK次数
> 基本规则（RFC 1122）：接收方在以下任一条件满足时，必须立即发送 ACK：
>  1. 已收到 ≥2 个完整 TCP 段（无论是否连续）；
>  2. 等待时间达到延迟上限（通常 200ms）；
>  3. 收到带有 PUSH 标志的数据（某些实现）；
>  4. 收到乱序段（out-of-order segment） → 多数现代 TCP 会立即 ACK（即使未满 2 段），以触发快速重传。

## 2 TCP协议窗口实现
* TCP传输最小的基本单元是Sgement，每个Segemnt基于Byte字节流，每次业务传输包含多个Sgement；
* TCP协议时是动态滑动窗口；
* 收端窗口可以控制接受能力，发端根据网络拥堵情况可以动态调整发送端窗口大小
* 重传无需心跳机制，阻塞，依赖ACK的恢复；
详细画了一次传输丢包重传图
![TCP协议窗口机制](/img/TCP协议窗口机制.png)

## 3 RTPS协议Reliable窗口实现
* RTPS传输最小基本单元是Submessage，每次业务数据传输包含多个Submessage；
* RTPS两端窗口完全独立；
* Pub窗口取决于Pub发送的数据速率，先进先出，Qos:history.depth
* Sub窗口取决于是不是乱序来出队；Qos:ResouceLimits
* 重传依赖心跳机制，Sub通知Pub没收到那些序号的数据，要重传；
详见一次传输丢包重传图
![RTPS协议Reliable实现](/img/RTPS协议窗口机制.png)


