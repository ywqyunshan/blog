---
layout:     post

title:      "整车通信框架-SOA"
subtitle:   ""
excerpt: ""
author:     "iigeoywq button"
date:       2025-11-08
published: true 
tags:
    - 系统理论 

categories: [ Tech ]
URL: "/2025/11/08/"
---

> 整车通信框架这两年有个概念SOA已经被说烂了，这个架构思路其实在互联网行业早都有了，DDS，SOA，CAN/LIN这些概念到底区别是啥？为啥汽车领域要突然使用SOA架构？can和dds如何解决网络的两大难题实时性和可靠性？另外，理想开源的mvbs通信架构具体如何实现dds的标准？如何在汽车的MCU上减低内存开销，结合源码分析服务发现，双向通信，可靠性

## 1 梳理概念
* SOA 是个架构思路，本质上以服务为中心，在互联网行业已经大行其道多年了；
* DDS 是个标准，是一种发布/订阅模式，在航天和工业已经是标准的通信协议了，SOA架构的通信主要基于dds标准实现；
* can/lin 底层的通信协议，类似传输层tcp或者udp协议，can/lin 更靠底层，理论上用can/lin也可以实现dds

## 2 汽车行业为什么突然使用SOA?
* 其实还是因为汽车电子电器架构的演进（参考我之前的梳理的[谈谈整车电子电器架构和全域操作系统](https://ywqyunshan.github.io/2025/11/01/)，整车电子电器架构要实现解耦，SOA框架是最适合的，以前大部分逻辑是在各个ECU实现的，互相耦合，举个简单例子吧，例如要实现"下雨天关窗"，看看2个架构的实现：
    * 传统架构实现涉及到雨量传感器，车窗控制器，两个ECU点对点，逻辑都在自己的模块实现，如果要继续实现"下雨管天窗"，两个ECU都要同时修改；
    * 现代电子电器架构已经通过soa抽象了一层，两个ECU不用动，域控制器来基于SOA定义的标准接口直接实现逻辑，可以控制各个ECU，ECU不需要改代码；
## 3 整车网络架构图
现代整车网络架构：主干是以太网，次级网络是CAN/LIN，直接让AI结合特斯拉，蔚小理，华为画一张简图,本文后面主要说主干DDS网络，CAN/LIN在下一篇RTOS的网络系统栈介绍。
![现代整车网络架构图](/img/整车网络架构图.png)

## 4 汽车网络需要解决的问题
汽车网络最终要解决2个问题：
实时性：确保数据以可预测延迟送达（时间确定性）
可靠性：确保数据不丢、不乱序或可重传

* 传统CAN总线
    * 通过"优先级仲裁 + 硬件定时确定性"解决实时性；
    * 通过CRC校验以及周期性解决可靠性；

* DDS
    * 基于UDP的RTPS协议 + QoS 实时策略（Priority、Deadline、LatencyBudget 等）共同实现实时性；
    * 通过 QoS(RELIABILITY) + ACKNACK/HEARTBEAT 重传机制实现可靠性；


## 5 理想mvbsLite通信框架源码分析
整车各跨域通信，既要部署在MPU上，也要部署在MCU 上，对于MCU来说资源受限，类似fastdds这类开源实现有点重，需要简化
理想的mvbs整车通信框架基于RTPS协议实现，主要做了
几个点优化：
* 内存：静态固定分配内存；
* 序列化：待研究；
* 传输：UDP 精简实现 + 系统内IPC通信；
* 发现：可选 DPSE 静态发现，降低启动时的网络风暴；
* QoS：精选策略 + e2e校验；
* 实现双向通信；
![mvbs架构](/img/mvbs架构.png)

### 5.1 服务发现
![DDS协议流程](/img/mvbs-dds发现.png)

* PDP (Participant Discovery Protocol) 阶段：参与者发现阶段--通过组播完成参与者发现与配对；
* EDP (Endpoint Discovery Protocol) 阶段：端点发现阶段--通过单播完成发布者(Publisher)/订阅者(Subscriber)匹配；
* 数据通信(Data Communication)--业务数据传输，通过单播直接传输数据；
### 5.2 双向通信封装
* 发布订阅流程
![发布订阅流程](/img/通信流程.png)
* 双向通信流程
mvbs的双向直接基于tcp协议实现，没有用RTPS协议
![双向通信流程](/img/双向通信.png)

### 5.2 QOS-Reliability和History
mvbslite 实现了8个策略，下面主要说一下Reliability和History；
*  Reliability：
    * BEST_EFFORT: 尽力而为传输，不保证数据送达。
    * RELIABLE: 可靠传输，通过ACK/NACK机制确保数据送达。

![RELIABLE机制](/img/mvbslite-RELIABLE.png)
* History：针对高频数据做缓存，有2个策略
    * KEEP_LAST: 适用于只需要最新状态的场景，如车辆速度。系统会自动覆盖最旧的数据，以节省内存；
    * KEEP_ALL: 适用于需要完整数据历史的场景，如数据记录。系统会尽可能保留所有数据；

### 5.3 序列化
研究中...

